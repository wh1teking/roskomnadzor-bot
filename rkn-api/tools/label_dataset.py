import csv
import json
import random
from collections import defaultdict

input_csv = 'dataset.csv'
output_csv = 'labeled_dataset.csv'
output_jsonl = 'labeled_dataset.jsonl'

labels = {
    0: 'норма',
    1: 'банворды (мат/оскорбления)',
    2: 'реклама',
    3: 'реклама читов',
    4: 'скам/раздачи',
    5: 'подстрекательство',
    6: 'оскорбление сервера',
    7: 'попрошайничество',
}

messages = []
with open(input_csv, encoding='utf-8') as f:
    reader = csv.DictReader(f)
    for row in reader:
        messages.append(row)

print('Классы для разметки:')
for k, v in labels.items():
    print(f'  {k}: {v}')
print('---')

banwords = [
    'блять', 'бля', 'сука', 'сук', 'мудила', 'пидор', 'пидорас', 'ебал', 'пздц', 'ебу', 'чмо', 'хуй', 'хуи', 'хуя', 'хуила', 'хуе', 'лох', 'пидр', 'ахуел', 'хуесос', 'пиздец', 'ты свинья', 'шлюха', 'позорище', 'пидорасина', 'иди нахуй', 'долбаеб', 'далбаеб', 'долбоеб', 'долбоёб', 'далбаёб', 'долбаёб', 'хуйлуша',
    "иди в жопу", "ты дебил", "заткнись нахуй", "ты тупой", "еблан", "мудак", "долбоёб", "чмо", "уёбок", "мразь", "тварь", "пошёл нахуй", "ебанат", "петух", "гандон", "соси хуй", "ебись об стену", "тупая овца", "козёл", "ублюдок", "мразота", "сучара", "даун", "идиот", "кретин", "тупица", "дебилка", "жирный", "лох", "тупорылый", "ебаный", "сдохни", "чёрт", "тупое чмо", "ебаный в рот", "ебаный урод", "ебаный осёл", "ебаный клоун", "тупой уёбок", "ебаный долбоёб", "ебаный мудак", "ебаный идиот", "ебаный дебил", "ебаный гандон", "ебаный петух", "ебаный пидор", "ебаный лох", "ебаный чёрт", "ебаный козёл", "ебаный ублюдок", "ебаный мразь", "ебаный тварь", "ебаный сучара", "ебаный даун", "ебаный кретин", "ебаный тупица", "ебаный дебилка", "ебаный жирный", "ебаный тупорылый", "ебаный чмо", "ебаный уёбок", "ебаный мразота", "ебаный сдохни", "ебаный иди в жопу", "ебаный заткнись", "ебаный пошёл нахуй", "ебаный соси хуй", "ебаный ебись об стену", "ебаный тупая овца", "ебаный козёл", "ебаный ублюдок", "ебаный мразота", "ебаный сучара", "ебаный пидор", "ебаный даун", "ебаный идиот", "ебаный кретин", "ебаный тупица", "ебаный дебилка", "ебаный жирный", "ебаный лох", "ебаный тупорылый", "ебаный чмо", "ебаный уёбок", "ебаный мразота", "ебаный сдохни", "ебаный чёрт", "ебаный козёл", "ебаный ублюдок", "ебаный мразь", "ебаный тварь", "ебаный сучара", "ебаный даун", "ебаный идиот", "ебаный кретин", "ебаный тупица", "ебаный дебилка", "ебаный жирный", "ебаный тупорылый", "ебаный чмо", "ебаный уёбок", "ебаный мразота", "ебаный сдохни", "ебаный иди в жопу", "ебаный заткнись", "ебаный пошёл нахуй", "ебаный соси хуй", "ебаный ебись об стену", "ебаный тупая овца", "ебаный козёл", "ебаный ублюдок", "ебаный мразота", "ебаный сучара", "ебаный пидор", "ебаный даун", "ебаный идиот", "ебаный кретин", "ебаный тупица", "ебаный дебилка", "ебаный жирный", "ебаный лох", "ебаный тупорылый", "ебаный чмо", "ебаный уёбок", "ебаный мразота", "ебаный сдохни", "ебаный чёрт", "ебаный козёл", "ебаный ублюдок", "ебаный мразь", "ебаный тварь", "ебаный сучара", "ебаный даун", "ебаный идиот", "ебаный кретин", "ебаный тупица", "ебаный дебилка", "ебаный жирный", "ебаный тупорылый", "ебаный чмо", "ебаный уёбок", "ебаный мразота", "ебаный сдохни"
]

message_ads = [
    'заходите', 'заходите на лучший', 'заходи на лучший', 'заходи', 'анархический', 'анархия', 'гриферский', 'айпи сервера', 'бесплатный донат', 'free op', 'бесплатная опка',
    "ВСЕМ СРОЧНО НА МОЙ СЕРВЕР", "ЗАХОДИТЕ НА СЕРВЕР", "ПРИСОЕДИНЯЙТЕСЬ К НАМ", "ЗАХОДИ НА СЕРВЕР", "ЛУЧШИЙ СЕРВЕР В МИРЕ", "ЗАХОДИ ИГРАТЬ", "НОВЫЙ СЕРВЕР ОТКРЫЛСЯ", "ПРИГЛАШАЕМ ВСЕХ", "УНИКАЛЬНЫЕ ВОЗМОЖНОСТИ", "НЕ УПУСТИ ШАНС", "ЗАХОДИ НА МОЙ СЕРВЕР", "ВСЕ ДРУЗЬЯ УЖЕ НА МОЁМ СЕРВЕРЕ", "САМЫЙ АКТИВНЫЙ СЕРВЕР", "ПРИСОЕДИНЯЙСЯ К ЛУЧШЕМУ СЕРВЕРУ", "ЗАХОДИ НА СЕРВЕР! КАЖДОМУ НОВИЧКУ ПОДАРОК", "СЕРВЕР ДЛЯ НАСТОЯЩИХ ИГРОКОВ", "ЗАХОДИ НА СЕРВЕР! ТОЛЬКО СЕГОДНЯ АКЦИЯ", "ПРИГЛАШАЮ ВСЕХ НА МОЙ СЕРВЕР", "ЗАХОДИ НА СЕРВЕР! СКИДКИ И БОНУСЫ", "СЕРВЕР МЕЧТЫ ЖДЁТ ТЕБЯ", "ЗАХОДИ НА МОЙ СЕРВЕР! ВСЕ УЖЕ ТУТ"
]

message_cheat_ads = [
    'thunderhack', 'neverlose', 'neverlose.cc', 'nursultan', 'celestial', 'catlavan', 'catlean', 'wexside', 'тх', 'тандерхак', 'неверлуз', 'нурик', 'нурсултан', 'целка', 'целестиал', 'катлаван', 'newcode'
]

message_scum_ads = [
    'раздача доната', 'раздача дк', 'раздача донат кейсов', 'раздача титул кейсов', 'раздача кейсов', 'раздача донат', 'раздача тк', 'лютая раздача',
    "Сегодня акция: раздача донат кейсов", "Кто хочет халявный донат", "раздача дк", "раздача доната", "раздача титул кейсов", "раздача кейсов", "раздача донат", "раздача тк", "лютая раздача", "раздаём донат-кейсы", "раздача донат кейсов", "раздача доната бесплатно", "раздача доната новичкам", "раздача доната за отзыв", "раздача доната за скрин", "раздача доната без условий", "раздача доната без подвоха", "раздача доната всем", "раздача доната за отзыв на форуме", "раздача доната за скрин", "раздача доната за отзыв", "раздача доната за скрин", "раздача доната за отзыв", "раздача доната за скрин", "раздача доната за отзыв", "раздача доната за скрин", "раздача доната за отзыв"
]

message_incitement = [
    'дай акк', 'продай акк', 'акк', 'аккаунт', 'продам акк', 'куплю акк',
    "продам аккаунт", "куплю аккаунт", "отдам аккаунт за деньги", "продам доступ", "продам логи", "продам вещи за реал", "давай вместе обманем", "давай скамернем кого-нибудь", "обойди античит", "обойди бан", "давай дюпать", "давай использовать баг", "давай нарушим правила", "помоги мне с дюпом", "помоги с обходом", "помоги с читами", "помоги с взломом", "помоги с фейком", "помоги с обманом", "помоги с продажей аккаунта"
]

message_server_abuse = [
    'сервер говн', 'сервер гавн', 'сервер хуй', 'серв говн', 'серв гавн',
    'серв хуй', 'хуйня серв', 'говно серв', 'говнище серв', 'сервер говно',
    'админы дебилы', 'тупой сервер', 'худший сервер', 'админы идиоты', 'сервер лагает',
    'ужасный сервер', 'админы не умеют', 'отстойный сервер', 'сервер полное говно', 'сервер для даунов',
    "сервер говно", "админы дебилы", "тупой сервер", "худший сервер", "админы идиоты", "сервер лагает", "ужасный сервер", "админы не умеют", "отстойный сервер", "сервер полное говно", "сервер для даунов", "сервер мертвый", "сервер для нубов", "сервер дно", "сервер сдох", "сервер умирает", "сервер как помойка", "сервер для идиотов", "сервер для школьников", "сервер днище", "сервер неиграбельный", "сервер полный отстой", "сервер хуже некуда", "сервер глючит постоянно", "сервер лагает как помойка", "админы ничего не делают", "админы бесполезные", "админы только банят", "админы неадекваты", "админы не следят за сервером", "админы не помогают", "админы только мешают", "админы тупые", "админы не отвечают", "админы не умеют управлять", "админы не шарят", "админы некомпетентные", "админы неадекватные", "админы не слушают игроков", "админы игнорируют", "админы не справляются", "сервер для ботов", "сервер для читеров", "сервер для токсиков", "сервер для крыс", "сервер для донатеров", "сервер для багов", "сервер багованный", "сервер не обновляется", "сервер устарел", "сервер не развивается", "сервер никому не нужен", "сервер никому не интересен", "сервер никчёмный", "сервер не стоит времени", "сервер не стоит внимания", "сервер не стоит денег", "сервер не стоит играть", "сервер не для людей", "сервер не для нормальных игроков"
]
message_begging = ['дайте', 'пж', 'пожалуйста', 'очень нужно', 'кто даст', 'помогите', 'помоги', 'нужны деньги', 'нужна помощь', 'срочно нужно', 'кто поможет', 'дай', 'дайте пж', 'пж дайте', 'хочу дом', 'построить дом', 'для постройки', 'выдайте', 'кто даст', 'кто скинет', 'скиньте', 'подайте', 'пж помогите', 'пж помоги', 'пж скиньте', 'пж дайте', 'пж кто нибудь', 'очень надо', 'очень нужно', 'очень нужен', 'очень нужны', 'не жалко', 'кому не жалко']

def auto_label(text):
    t = text.lower()
    if any(word in t for word in banwords):
        return 1
    if any(word in t for word in message_ads):
        return 2
    if any(word in t for word in message_cheat_ads):
        return 3
    if any(word in t for word in message_scum_ads):
        return 4
    if any(word in t for word in message_incitement):
        return 5
    if any(word in t for word in message_server_abuse):
        return 6
    if any(word in t for word in message_begging):
        return 7
    return 0

for i, msg in enumerate(messages):
    if 'label' in msg and msg['label'].strip() != '':
        continue
    msg['label'] = auto_label(msg['text'])

classed = defaultdict(list)
for msg in messages:
    classed[msg['label']].append(msg)

max_other = max(len(classed[i]) for i in range(1, 8))
norma_limit = max_other * 2

norma_msgs = classed[0]
if len(norma_msgs) > norma_limit:
    norma_msgs = random.sample(norma_msgs, norma_limit)

final_messages = []
for k in classed:
    if k == 0:
        final_messages.extend(norma_msgs)
    else:
        final_messages.extend(classed[k])

print(f'До урезания: норма={len(classed[0])}, после={len(norma_msgs)}')
print(f'Итоговый размер датасета: {len(final_messages)}')

messages = final_messages

with open(output_csv, 'w', encoding='utf-8', newline='') as f:
    writer = csv.DictWriter(f, fieldnames=['time', 'text', 'label'])
    writer.writeheader()
    for msg in messages:
        writer.writerow(msg)

with open(output_jsonl, 'w', encoding='utf-8') as f:
    for msg in messages:
        f.write(json.dumps(msg, ensure_ascii=False) + '\n')

print(f'\nГотово! Размечено {sum(1 for m in messages if m["label"])} сообщений.')
print(f'Сохранено в {output_csv} и {output_jsonl}')

from collections import Counter
label_counts = Counter(m['label'] for m in messages if m['label'])
print('\nСтатистика по классам:')
for label, count in sorted(label_counts.items()):
    label_name = labels.get(int(label), 'Неизвестно')
    print(f'  Класс {label}: {label_name} — {count} сообщений')

print('Пример меток:', [msg['label'] for msg in messages[:20]])
